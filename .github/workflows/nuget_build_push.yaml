name: publish nuget

on:
  workflow_call:
    inputs:
      projfile:
        description: 'The path to the project file to be built'
        default: 'MISSING PROJECT FILE'
        required: true
        type: string
    secrets:
      NUGET_SOURCE_MYGET: 
        required: true
      MYGET_FEED_SERVER:
        required: true
      MYGET_API_KEY:
        required: true
      MYGET_SYMBOLS_FEED_SERVER:
        required: true
      MYGET_SYMBOLS_API_KEY:
        required: true



jobs:
  pack-and-push:
    runs-on: [self-hosted, linux]
    steps:
    - uses: actions/checkout@v1
      name: Checkout Code
     
    - uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '5.0.x'
      name: Setup dotnet

    - name: pack project 
      run: >
        dotnet pack ${{ inputs.projfile }} 
        /p:Configuration=Release 
        --source ${{secrets.NUGET_SOURCE_MYGET}}  
        --source https://api.nuget.org/v3/index.json
        --include-source 
        -o ./.pub

    - name: Publish the package to proget
      run: >
        dotnet nuget push ./.pub/*.nupkg 
        --source ${{secrets.MYGET_FEED_SERVER}} 
        --api-key ${{secrets.MYGET_API_KEY}} 
        --symbol-source ${{secrets.MYGET_SYMBOLS_FEED_SERVER}} 
        -sk ${{secrets.MYGET_SYMBOLS_API_KEY}} 
        --skip-duplicate
        
